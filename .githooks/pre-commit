staged=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go' || true)

go test ./...

if [ -z "$staged" ]; then
	exit 0;
fi

unformatted=$(gofmt -l $staged)
if [ -n "$unformatted" ]; then
	echo "\nThe following files are unformatted:";
	echo "$unformatted" | awk '{print "\t- " $0}'
	echo "\nRun go fmt ./... to fix.";
	exit 1;
fi